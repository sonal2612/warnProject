{% extends "base.html" %}
{% block title %}Resolve Report{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin-top: 30px;">
    <h2 class="mb-4" style="font-weight: 700; color: #212529;">âœ… Resolve Report #{{ report.id }}</h2>
    
    <div class="card mb-4" style="border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #f8f9fa; font-weight: 600;">
            ğŸ“‹ Original Report Details
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>ğŸ¾ Animal Type:</strong> {{ report.animal_type }}</p>
                    <p><strong>âš ï¸ Condition:</strong> {{ report.condition }}</p>
                    <p><strong>ğŸ“§ Reporter Email:</strong> {{ report.reporter_email }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>ğŸ• Reported:</strong> {{ report.timestamp.strftime('%Y-%m-%d %H:%M') }}</p>
                    <p><strong>ğŸ“ Location:</strong> <a href="https://www.google.com/maps?q={{ report.latitude }},{{ report.longitude }}" target="_blank">View on Map</a></p>
                </div>
            </div>
            {% if report.description %}
            <p><strong>ğŸ“ Description:</strong> {{ report.description }}</p>
            {% endif %}
            {% if report.image_filename %}
            <div class="mt-3">
                <strong>ğŸ“· Original Image:</strong><br>
                <img src="{{ url_for('static', filename='uploads/' + report.image_filename) }}" style="max-width: 100%; border-radius: 10px; margin-top: 10px;">
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card" style="border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <div class="card-header" style="background-color: #28a745; color: white; font-weight: 600;">
            âœ… Resolution Details
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="resolution_notes" class="form-label"><strong>ğŸ“ Final Condition & Notes:</strong><sup style="color:red;">*</sup></label>
                    <textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="5" placeholder="Describe the animal's final condition, treatment provided, and outcome..." required></textarea>
                    <small class="text-muted">This will be sent to the reporter via email</small>
                </div>

                <div class="mb-3">
                    <label for="resolution_image" class="form-label"><strong>ğŸ“· Final Image (Optional):</strong></label>
                    <div class="btn-group w-100 mb-2" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('resolution_image').click()">ğŸ“ Upload</button>
                        <button type="button" class="btn btn-outline-primary" onclick="openResolutionCamera()">ğŸ“· Capture</button>
                    </div>
                    <input type="file" id="resolution_image" name="resolution_image" class="form-control d-none" accept="image/*">
                    <video id="resolutionCamera" style="display:none; width:100%; border-radius:8px; margin-top:10px;" autoplay></video>
                    <canvas id="resolutionCanvas" style="display:none;"></canvas>
                    <img id="resolutionPreview" style="display:none; width:100%; border-radius:8px; margin-top:10px;" />
                    <button type="button" id="resolutionCaptureBtn" class="btn btn-success w-100 mt-2" style="display:none;" onclick="captureResolutionImage()">âœ”ï¸ Capture Photo</button>
                    <button type="button" id="resolutionRetakeBtn" class="btn btn-warning w-100 mt-2" style="display:none;" onclick="retakeResolutionPhoto()">ğŸ”„ Retake</button>
                    <small class="text-muted">Upload or capture a photo showing the animal's final condition</small>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success btn-lg" style="flex: 1; font-weight: 600;">âœ… Mark as Resolved & Notify Reporter</button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg">âŒ Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let resolutionStream = null;

function openResolutionCamera() {
    const video = document.getElementById('resolutionCamera');
    const captureBtn = document.getElementById('resolutionCaptureBtn');
    
    video.style.display = 'block';
    captureBtn.style.display = 'block';
    
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(function(s) {
            resolutionStream = s;
            video.srcObject = resolutionStream;
        })
        .catch(function(err) {
            alert('Camera access denied or not available');
            video.style.display = 'none';
            captureBtn.style.display = 'none';
        });
}

function captureResolutionImage() {
    const video = document.getElementById('resolutionCamera');
    const canvas = document.getElementById('resolutionCanvas');
    const preview = document.getElementById('resolutionPreview');
    const captureBtn = document.getElementById('resolutionCaptureBtn');
    const retakeBtn = document.getElementById('resolutionRetakeBtn');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    canvas.toBlob(function(blob) {
        const file = new File([blob], "resolution_image.jpg", { type: "image/jpeg" });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        document.getElementById('resolution_image').files = dataTransfer.files;
        
        preview.src = URL.createObjectURL(blob);
        preview.style.display = 'block';
    }, 'image/jpeg');
    
    if (resolutionStream) {
        resolutionStream.getTracks().forEach(track => track.stop());
    }
    video.style.display = 'none';
    captureBtn.style.display = 'none';
    retakeBtn.style.display = 'block';
}

function retakeResolutionPhoto() {
    const preview = document.getElementById('resolutionPreview');
    const retakeBtn = document.getElementById('resolutionRetakeBtn');
    
    preview.style.display = 'none';
    retakeBtn.style.display = 'none';
    document.getElementById('resolution_image').value = '';
    
    openResolutionCamera();
}
</script>
{% endblock %}
